#!/usr/bin/python

import time
import subprocess
import os
import socket
import lxml.etree as et

# Graphite Server settings
graphite_server = 'sever-ip'
port = 'carbon-port'

# Get hpcc component name 
roxie_name = os.popen("service hpcc-init -c roxie status|awk '{print $1}'").readline().replace('\n', '')
cmd = '2>/dev/null testsocket . "<control:metrics/>"'

# Socket connection
sender = socket.socket()
sender.connect((graphite_server, port))

while True:
    get_metrics = os.popen(cmd).read()
    if get_metrics:
        parse_xml = et.fromstring(get_metrics)
        doc_root = parse_xml
        for ip in doc_root:
            ip_address = ip.attrib['ep'].replace(':9876', '')
        for metric in doc_root.iter('Metric'):
            roxie_metrics = '%s.%s.%s.%d.%d\n' % (roxie_name, ip_address.replace('.', '_'),
                                                  metric.attrib['name'], int(metric.attrib['value']), time.time())
            sender.sendall(roxie_metrics)

